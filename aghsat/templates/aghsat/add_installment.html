<!-- aghsat/templates/aghsat/add_installment.html -->

{% extends 'aghsat/base.html' %}

{% block content %}
<h2 class="mb-4">تعریف لیست اقساط</h2>

<div class="card">
    <div class="card-body p-4">
        <form method="POST">
            {% csrf_token %}
            
            <h5 class="mb-3">اطلاعات مشتری</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">{{ customer_form.first_name.label }}</label>
                    {{ customer_form.first_name }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">{{ customer_form.last_name.label }}</label>
                    {{ customer_form.last_name }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">{{ customer_form.mobile.label }}</label>
                    {{ customer_form.mobile }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">{{ customer_form.line_sold.label }}</label>
                    {{ customer_form.line_sold }}
                </div>
            </div>
            
            <hr class="my-4">
            
            <h5 class="mb-3">اطلاعات قسط</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">{{ installment_form.amount.label }}</label>
                    {{ installment_form.amount }}
                    <small class="text-muted d-block mt-1">اعداد به صورت خودکار فرمت می‌شوند</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">{{ installment_form.payment_date.label }}</label>
                    {{ installment_form.payment_date }}
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check mt-4">
                        {{ installment_form.is_paid }}
                        <label class="form-check-label">
                            پرداخت شده
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-success btn-lg mt-3">
                <i class="bi bi-check-circle"></i> ذخیره
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تابع فرمت‌دهی عدد با کاما
    function formatNumber(value) {
        // حذف همه چیز به جز اعداد
        let num = value.replace(/[^\d]/g, '');
        
        if (num === '') return '';
        
        // تبدیل به عدد و اضافه کردن کاما
        return parseInt(num).toLocaleString('en-US');
    }
    
    // تابع حذف فرمت (برای ارسال به سرور)
    function unformatNumber(value) {
        return value.replace(/,/g, '');
    }
    
    // اعمال فرمت به فیلد مبلغ
    const amountInput = document.querySelector('input[name="amount"]');
    
    if (amountInput) {
        // اگر مقدار اولیه داشت، فرمت کن
        if (amountInput.value) {
            amountInput.value = formatNumber(amountInput.value);
        }
        
        // هنگام تایپ
        amountInput.addEventListener('input', function(e) {
            let cursorPosition = this.selectionStart;
            let oldLength = this.value.length;
            let oldValue = this.value;
            
            // فرمت کردن
            let formatted = formatNumber(this.value);
            this.value = formatted;
            
            // محاسبه موقعیت جدید کرسر
            let newLength = this.value.length;
            let diff = newLength - oldLength;
            
            // اگر کاراکتر اضافه شد (کاما)
            if (diff > 0) {
                cursorPosition += diff;
            }
            
            // تنظیم موقعیت کرسر
            this.setSelectionRange(cursorPosition, cursorPosition);
        });
        
        // قبل از سابمیت فرم
        const form = amountInput.closest('form');
        form.addEventListener('submit', function(e) {
            // حذف کاماها برای ارسال به سرور
            amountInput.value = unformatNumber(amountInput.value);
        });
    }
});
</script>
{% endblock %}
